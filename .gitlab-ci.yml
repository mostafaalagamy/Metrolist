# GitLab CI/CD Pipeline for Metrolist
# Build Android APKs for multiple architectures

stages:
  - prepare
  - build
  - collect
  - release

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"
  GRADLE_USER_HOME: ".gradle"
  ANDROID_SDK_ROOT: "/opt/android-sdk"
  ANDROID_HOME: "/opt/android-sdk"

# Global cache for Gradle
cache:
  key: gradle-cache
  paths:
    - .gradle/wrapper
    - .gradle/caches

# Prepare Android SDK (shared across jobs)
prepare_sdk:
  stage: prepare
  image: openjdk:21-jdk-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq wget unzip
  script:
    - wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
    - unzip -q commandlinetools-linux-11076708_latest.zip
    - mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
    - mv cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest
    - export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin
    - yes | sdkmanager --licenses >/dev/null 2>&1
    - sdkmanager --install "platform-tools" "platforms;android-34" "build-tools;35.0.0" >/dev/null
  artifacts:
    paths:
      - $ANDROID_SDK_ROOT
    expire_in: 2 hours
  cache:
    key: android-sdk-cache
    paths:
      - $ANDROID_SDK_ROOT

# Build job template
.build_template: &build_template
  stage: build
  image: openjdk:21-jdk-slim
  dependencies:
    - prepare_sdk
  before_script:
    - export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools
    - chmod +x gradlew
    # Verify SDK installation
    - ls -la $ANDROID_SDK_ROOT/
    - which adb || echo "ADB not found, continuing..."
  script:
    - echo "Building ${ABI} variant..."
    - ./gradlew clean assemble${ABI}Release --stacktrace --info
  artifacts:
    paths:
      - app/build/outputs/apk/${ABI_LOWER}/release/
    expire_in: 2 hours
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "**/*.kt"
        - "**/*.java"
        - "**/*.gradle"
        - "**/*.gradle.kts"
        - "gradle.properties"
        - "gradle/wrapper/**"
        - "app/src/**"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  timeout: 30m

# Build jobs for different ABIs
build_arm64:
  <<: *build_template
  variables:
    ABI: "Arm64"
    ABI_LOWER: "arm64"
  artifacts:
    name: "app-arm64-release-$CI_COMMIT_SHORT_SHA"

build_armeabi:
  <<: *build_template
  variables:
    ABI: "Armeabi"
    ABI_LOWER: "armeabi"
  artifacts:
    name: "app-armeabi-release-$CI_COMMIT_SHORT_SHA"

build_x86:
  <<: *build_template
  variables:
    ABI: "X86"
    ABI_LOWER: "x86"
  artifacts:
    name: "app-x86-release-$CI_COMMIT_SHORT_SHA"

build_x86_64:
  <<: *build_template
  variables:
    ABI: "X86_64"
    ABI_LOWER: "x86_64"
  artifacts:
    name: "app-x86_64-release-$CI_COMMIT_SHORT_SHA"

build_universal:
  <<: *build_template
  variables:
    ABI: "Universal"
    ABI_LOWER: "universal"
  artifacts:
    name: "app-universal-release-$CI_COMMIT_SHORT_SHA"

# Build debug version (for testing)
build_debug:
  stage: build
  image: openjdk:21-jdk-slim
  dependencies:
    - prepare_sdk
  before_script:
    - export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools
    - chmod +x gradlew
    # Create debug keystore
    - mkdir -p app/
    - keytool -genkey -v -keystore ./app/debug.keystore -alias debug -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Debug,OU=Debug,O=Debug,L=Debug,S=Debug,C=US" -storepass android -keypass android 2>/dev/null || true
  script:
    - echo "Building debug variant..."
    - ./gradlew assembleUniversalDebug --stacktrace
  artifacts:
    paths:
      - app/build/outputs/apk/universal/debug/
    name: "app-universal-debug-$CI_COMMIT_SHORT_SHA"
    expire_in: 1 day
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH != "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "web"
  timeout: 20m

# Collect all APKs
collect_apks:
  stage: collect
  image: alpine:latest
  script:
    - echo "Collecting all built APKs..."
    - mkdir -p release_apks
    - find app/build/outputs/apk/ -name "*.apk" -type f | while read apk; do
        echo "Found APK: $apk"
        cp "$apk" release_apks/ || echo "Failed to copy $apk"
      done
    - ls -la release_apks/
    - echo "Total APKs collected: $(ls -1 release_apks/*.apk 2>/dev/null | wc -l)"
  artifacts:
    paths:
      - release_apks/
    name: "metrolist-all-apks-$CI_COMMIT_SHORT_SHA"
    expire_in: 1 month
  dependencies:
    - build_arm64
    - build_armeabi
    - build_x86
    - build_x86_64
    - build_universal
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_TAG

# Create GitLab release (only for tags)
create_release:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - echo "Creating GitLab release for tag $CI_COMMIT_TAG"
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        echo "Tag detected: $CI_COMMIT_TAG"
        # Create release using GitLab API
        curl --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
             --data "name=$CI_COMMIT_TAG" \
             --data "tag_name=$CI_COMMIT_TAG" \
             --data "description=Release $CI_COMMIT_TAG" \
             --request POST \
             "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases" || echo "Release creation failed"
      fi
  dependencies:
    - collect_apks
  rules:
    - if: $CI_COMMIT_TAG
  allow_failure: true

# Lint and test (optional, runs in parallel)
lint_and_test:
  stage: build
  image: openjdk:21-jdk-slim
  dependencies:
    - prepare_sdk
  before_script:
    - export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools
    - chmod +x gradlew
  script:
    - echo "Running lint and tests..."
    - ./gradlew lint --stacktrace || echo "Lint warnings found"
    - ./gradlew test --stacktrace || echo "Some tests failed"
  artifacts:
    reports:
      junit: "**/build/test-results/test/TEST-*.xml"
    paths:
      - "**/build/reports/"
    expire_in: 1 day
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"
  allow_failure: true
  timeout: 15m