# GitLab CI/CD Pipeline for Metrolist
# Build Android APKs for multiple architectures

stages:
  - prepare
  - build
  - collect
  - release

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"
  GRADLE_USER_HOME: ".gradle"
  ANDROID_SDK_ROOT: "/opt/android-sdk"
  ANDROID_HOME: "/opt/android-sdk"

# Global cache for Gradle
cache:
  key: gradle-cache
  paths:
    - .gradle/wrapper
    - .gradle/caches

# Prepare Android SDK (shared across jobs)
prepare_sdk:
  stage: prepare
  image: openjdk:21-jdk-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq wget unzip
  script:
    - |
      echo "Setting up Android SDK..."
      
      # Download Android command line tools
      wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
      unzip -q commandlinetools-linux-11076708_latest.zip
      
      # Setup Android SDK directory structure
      mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
      mv cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest
      
      # Set PATH for sdkmanager
      export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools
      
      # Accept licenses automatically
      mkdir -p $ANDROID_SDK_ROOT/licenses
      echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
      echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
      echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
      
      # Install required SDK components
      sdkmanager --install "platform-tools" "platforms;android-34" "build-tools;35.0.0"
      
      # Verify installation
      echo "Android SDK setup completed"
      ls -la $ANDROID_SDK_ROOT/
  artifacts:
    paths:
      - $ANDROID_SDK_ROOT
    expire_in: 2 hours
  cache:
    key: android-sdk-cache
    paths:
      - $ANDROID_SDK_ROOT

# Build job template
.build_template: &build_template
  stage: build
  image: openjdk:21-jdk-slim
  dependencies:
    - prepare_sdk
  before_script:
    - export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools
    - chmod +x gradlew
    - echo "Verifying Android SDK setup..."
    - ls -la $ANDROID_SDK_ROOT/ || echo "SDK directory not found"
  script:
    - |
      echo "Building ${ABI} variant..."
      export ANDROID_HOME=$ANDROID_SDK_ROOT
      export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools
      ./gradlew clean assemble${ABI}Release --stacktrace
  artifacts:
    paths:
      - app/build/outputs/apk/${ABI_LOWER}/release/
    expire_in: 2 hours
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - "**/*.kt"
        - "**/*.java"
        - "**/*.gradle"
        - "**/*.gradle.kts"
        - "gradle.properties"
        - "gradle/wrapper/**"
        - "app/src/**"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  timeout: 30m
  allow_failure: true

# Build jobs for different ABIs
build_arm64:
  <<: *build_template
  variables:
    ABI: "Arm64"
    ABI_LOWER: "arm64"
  artifacts:
    name: "app-arm64-release-$CI_COMMIT_SHORT_SHA"

build_armeabi:
  <<: *build_template
  variables:
    ABI: "Armeabi"
    ABI_LOWER: "armeabi"
  artifacts:
    name: "app-armeabi-release-$CI_COMMIT_SHORT_SHA"

build_x86:
  <<: *build_template
  variables:
    ABI: "X86"
    ABI_LOWER: "x86"
  artifacts:
    name: "app-x86-release-$CI_COMMIT_SHORT_SHA"

build_x86_64:
  <<: *build_template
  variables:
    ABI: "X86_64"
    ABI_LOWER: "x86_64"
  artifacts:
    name: "app-x86_64-release-$CI_COMMIT_SHORT_SHA"

build_universal:
  <<: *build_template
  variables:
    ABI: "Universal"
    ABI_LOWER: "universal"
  artifacts:
    name: "app-universal-release-$CI_COMMIT_SHORT_SHA"

# Build debug version (for testing)
build_debug:
  stage: build
  image: openjdk:21-jdk-slim
  dependencies:
    - prepare_sdk
  before_script:
    - export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools
    - chmod +x gradlew
    - echo "Setting up debug keystore..."
    - mkdir -p app/
    - keytool -genkey -v -keystore ./app/debug.keystore -alias debug -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Debug,OU=Debug,O=Debug,L=Debug,S=Debug,C=US" -storepass android -keypass android 2>/dev/null || true
  script:
    - |
      echo "Building debug variant..."
      export ANDROID_HOME=$ANDROID_SDK_ROOT
      export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools
      ./gradlew assembleUniversalDebug --stacktrace
  artifacts:
    paths:
      - app/build/outputs/apk/universal/debug/
    name: "app-universal-debug-$CI_COMMIT_SHORT_SHA"
    expire_in: 1 day
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH != "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "web"
  timeout: 20m

# Collect all APKs
collect_apks:
  stage: collect
  image: alpine:latest
  script:
    - echo "Collecting all built APKs..."
    - mkdir -p release_apks
    - echo "Checking for APK build outputs..."
    - |
      # Function to copy APKs safely
      copy_apks() {
        if [ -d "app/build/outputs/apk/" ]; then
          echo "Found APK build directory"
          find app/build/outputs/apk/ -name "*.apk" -type f -exec cp {} release_apks/ \; 2>/dev/null || true
        else
          echo "No app/build/outputs/apk/ directory found"
        fi
        
        # Check for APKs in other locations
        find . -maxdepth 3 -name "*.apk" -type f -not -path "./release_apks/*" -exec cp {} release_apks/ \; 2>/dev/null || true
      }
      
      # Execute function
      copy_apks
      
      # Count results
      apk_count=$(find release_apks/ -name "*.apk" -type f | wc -l)
      echo "APKs found and copied: $apk_count"
      
      if [ "$apk_count" -eq 0 ]; then
        echo "WARNING: No APKs were collected!"
        echo "This is expected if build jobs failed or are still running."
        echo "Creating placeholder for artifact consistency"
        echo "No APKs collected - build jobs may have failed" > release_apks/README.txt
      else
        echo "Successfully collected $apk_count APK(s):"
        ls -la release_apks/
      fi
      
      echo "Collect APKs job completed"
  artifacts:
    paths:
      - release_apks/
    name: "metrolist-all-apks-$CI_COMMIT_SHORT_SHA"
    expire_in: 1 month
  dependencies: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_COMMIT_TAG
  when: always

# Create GitLab release (only for tags)
create_release:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Creating GitLab release for tag $CI_COMMIT_TAG"
      if [ -n "$CI_COMMIT_TAG" ]; then
        echo "Tag detected: $CI_COMMIT_TAG"
        # Create release using GitLab API
        curl --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
             --data "name=$CI_COMMIT_TAG" \
             --data "tag_name=$CI_COMMIT_TAG" \
             --data "description=Release $CI_COMMIT_TAG" \
             --request POST \
             "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases" || echo "Release creation failed"
      fi
  dependencies:
    - collect_apks
  rules:
    - if: $CI_COMMIT_TAG
  allow_failure: true

# Lint and test (optional, runs in parallel)
lint_and_test:
  stage: build
  image: openjdk:21-jdk-slim
  dependencies:
    - prepare_sdk
  before_script:
    - export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools
    - chmod +x gradlew
  script:
    - echo "Running lint and tests..."
    - ./gradlew lint --stacktrace || echo "Lint warnings found"
    - ./gradlew test --stacktrace || echo "Some tests failed"
  artifacts:
    reports:
      junit: "**/build/test-results/test/TEST-*.xml"
    paths:
      - "**/build/reports/"
    expire_in: 1 day
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"
  allow_failure: true
  timeout: 15m